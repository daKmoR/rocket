{% if content.jsCode %}
  <script type="module">
    {{ content.jsCode | safe }}
  </script>
{% endif %}

{% if site.analytics %}
  <script type="module">
    window.ga = window.ga || ((...args) => (ga.q = ga.q || []).push(args));

    ga('create', '{{ site.analytics }}', 'auto');
    ga('set', 'transport', 'beacon');
    ga('send', 'pageview');
  </script>
  <script async="async" src="https://www.google-analytics.com/analytics.js"></script>
{% endif %}

<script>
  async function handleUpdate() {
    const oldSw = (await navigator.serviceWorker.getRegistration())?.active?.state;

    if ("serviceWorker"in navigator) {
      let refreshing;

      navigator.serviceWorker.addEventListener('controllerchange', async () => {
        if (refreshing) return;

        const newSw = (await navigator.serviceWorker.getRegistration())?.active?.state;

        if(oldSw === 'activated' && newSw === 'activating') {
          refreshing = true;
          window.location.reload();
        }
      });
    }
  }

  handleUpdate();
</script>
